// Owo- DIY Tax Filing App
// Built with ‚ù§Ô∏è for Nigerian taxpayers

// ============================================
// Owo - Authentication System
// ============================================

console.log('üöÄ TaxNaija initializing...');

// ============================================
// GOOGLE OAUTH CONFIGURATION
// ============================================

// üîë PASTE YOUR CLIENT ID HERE (from Google Cloud Console)
const GOOGLE_CLIENT_ID = '107560824332-r11ubimm7nfadp6g8s3q9r8r4ghomp9s.apps.googleusercontent.com';
// ‚ö†Ô∏è IMPORTANT: Replace 'YOUR_CLIENT_ID_HERE' with your actual Client ID!
// Example: '123456789-abcdefg.apps.googleusercontent.com'

// ============================================
// USER STATE
// ============================================

let currentUser = null; // Will store logged-in user info

// ============================================
// LOCAL STORAGE (Database on phone)
// ============================================

const DB = {
  /**
     * Save data to browser storage
        */
          save(key, data) {
              try {
                    localStorage.setItem(key, JSON.stringify(data));
                          console.log(`‚úÖ Saved ${key}`);
                                return true;
                                    } catch (error) {
                                          console.error(`‚ùå Failed to save ${key}:`, error);
                                                return false;
                                                    }
                                                      },

                                                        /**
                                                           * Load data from browser storage
                                                              */
                                                                load(key, defaultValue = null) {
                                                                    try {
                                                                          const data = localStorage.getItem(key);
                                                                                if (data === null) return defaultValue;
                                                                                      console.log(`‚úÖ Loaded ${key}`);
                                                                                            return JSON.parse(data);
                                                                                                } catch (error) {
                                                                                                      console.error(`‚ùå Failed to load ${key}:`, error);
                                                                                                            return defaultValue;
                                                                                                                }
                                                                                                                  },

                                                                                                                    /**
                                                                                                                       * Delete data
                                                                                                                          */
                                                                                                                            delete(key) {
                                                                                                                                localStorage.removeItem(key);
                                                                                                                                    console.log(`üóëÔ∏è Deleted ${key}`);
                                                                                                                                      }
                                                                                                                                      };

                                                                                                                                      // ============================================
                                                                                                                                      // GOOGLE SIGN-IN FUNCTIONS
                                                                                                                                      // ============================================

                                                                                                                                      /**
                                                                                                                                       * Initialize Google Sign-In
                                                                                                                                        * This runs when page loads
                                                                                                                                         */
                                                                                                                                         function initGoogleSignIn() {
                                                                                                                                           console.log('üîê Initializing Google Sign-In...');

                                                                                                                                             // Check if user was previously logged in
                                                                                                                                               const savedUser = DB.load('currentUser');
                                                                                                                                                 if (savedUser) {
                                                                                                                                                     console.log('üë§ Found saved user:', savedUser.name);
                                                                                                                                                         currentUser = savedUser;
                                                                                                                                                             showMainApp();
                                                                                                                                                                 return;
                                                                                                                                                                   }

                                                                                                                                                                     // Initialize Google Sign-In button
                                                                                                                                                                       google.accounts.id.initialize({
                                                                                                                                                                           client_id: GOOGLE_CLIENT_ID,
                                                                                                                                                                               callback: handleGoogleSignIn,
                                                                                                                                                                                   auto_select: false
                                                                                                                                                                                     });

                                                                                                                                                                                       // Render the button
                                                                                                                                                                                         google.accounts.id.renderButton(
                                                                                                                                                                                             document.getElementById('googleSignInButton'),
                                                                                                                                                                                                 {
                                                                                                                                                                                                       theme: 'filled_blue',
                                                                                                                                                                                                             size: 'large',
                                                                                                                                                                                                                   text: 'continue_with',
                                                                                                                                                                                                                         shape: 'rectangular',
                                                                                                                                                                                                                               width: 400
                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                     );

                                                                                                                                                                                                                                       console.log('‚úÖ Google Sign-In ready!');
                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                       /**
                                                                                                                                                                                                                                        * Handle successful Google Sign-In
                                                                                                                                                                                                                                         * This runs when user clicks "Sign in with Google"
                                                                                                                                                                                                                                          */
                                                                                                                                                                                                                                          function handleGoogleSignIn(response) {
                                                                                                                                                                                                                                            console.log('üéâ User signed in with Google!');

                                                                                                                                                                                                                                              // Decode the JWT token to get user info
                                                                                                                                                                                                                                                const userData = parseJwt(response.credential);
                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                    currentUser = {
                                                                                                                                                                                                                                                        id: userData.sub,
                                                                                                                                                                                                                                                            email: userData.email,
                                                                                                                                                                                                                                                                name: userData.name,
                                                                                                                                                                                                                                                                    picture: userData.picture,
                                                                                                                                                                                                                                                                        provider: 'google',
                                                                                                                                                                                                                                                                            createdAt: new Date().toISOString()
                                                                                                                                                                                                                                                                              };

                                                                                                                                                                                                                                                                                console.log('üë§ User info:', currentUser);

                                                                                                                                                                                                                                                                                  // Save user to localStorage
                                                                                                                                                                                                                                                                                    DB.save('currentUser', currentUser);

                                                                                                                                                                                                                                                                                      // Show main app
                                                                                                                                                                                                                                                                                        showMainApp();

                                                                                                                                                                                                                                                                                          // Show welcome message
                                                                                                                                                                                                                                                                                            alert(`Welcome, ${currentUser.name}! üéâ`);
                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                            /**
                                                                                                                                                                                                                                                                                             * Parse JWT token
                                                                                                                                                                                                                                                                                              * (Google sends user info as encoded token)
                                                                                                                                                                                                                                                                                               */
                                                                                                                                                                                                                                                                                               function parseJwt(token) {
                                                                                                                                                                                                                                                                                                 const base64Url = token.split('.')[1];
                                                                                                                                                                                                                                                                                                   const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                                                                                                                                                                                                                                                                                                     const jsonPayload = decodeURIComponent(
                                                                                                                                                                                                                                                                                                         atob(base64)
                                                                                                                                                                                                                                                                                                               .split('')
                                                                                                                                                                                                                                                                                                                     .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                                                                                                                                                                                                                                                                                                                           .join('')
                                                                                                                                                                                                                                                                                                                             );
                                                                                                                                                                                                                                                                                                                               return JSON.parse(jsonPayload);
                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                               /**
                                                                                                                                                                                                                                                                                                                                * Sign out user
                                                                                                                                                                                                                                                                                                                                 */
                                                                                                                                                                                                                                                                                                                                 function signOut() {
                                                                                                                                                                                                                                                                                                                                   if (confirm('Are you sure you want to sign out?')) {
                                                                                                                                                                                                                                                                                                                                       console.log('üëã User signing out...');
                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                               // Clear user data
                                                                                                                                                                                                                                                                                                                                                   currentUser = null;
                                                                                                                                                                                                                                                                                                                                                       DB.delete('currentUser');
                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                               // Reload page to show login screen
                                                                                                                                                                                                                                                                                                                                                                   window.location.reload();
                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                     // ============================================
                                                                                                                                                                                                                                                                                                                                                                     // UI DISPLAY FUNCTIONS
                                                                                                                                                                                                                                                                                                                                                                     // ============================================

                                                                                                                                                                                                                                                                                                                                                                     /**
                                                                                                                                                                                                                                                                                                                                                                      * Show login screen
                                                                                                                                                                                                                                                                                                                                                                       */
                                                                                                                                                                                                                                                                                                                                                                       function showLoginScreen() {
                                                                                                                                                                                                                                                                                                                                                                         document.getElementById('loginScreen').style.display = 'flex';
                                                                                                                                                                                                                                                                                                                                                                           document.getElementById('mainApp').style.display = 'none';
                                                                                                                                                                                                                                                                                                                                                                           }

                                                                                                                                                                                                                                                                                                                                                                           /**
                                                                                                                                                                                                                                                                                                                                                                            * Show main app (user is logged in)
                                                                                                                                                                                                                                                                                                                                                                             */
                                                                                                                                                                                                                                                                                                                                                                             function showMainApp() {
                                                                                                                                                                                                                                                                                                                                                                               document.getElementById('loginScreen').style.display = 'none';
                                                                                                                                                                                                                                                                                                                                                                                 document.getElementById('mainApp').style.display = 'block';
                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                     console.log('‚úÖ Main app displayed');
                                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                                     /**
                                                                                                                                                                                                                                                                                                                                                                                      * Show email login (placeholder for Day 2)
                                                                                                                                                                                                                                                                                                                                                                                       */
                                                                                                                                                                                                                                                                                                                                                                                       function showEmailLogin() {
                                                                                                                                                                                                                                                                                                                                                                                         alert('üìß Email login coming tomorrow! Use Google for now.');
                                                                                                                                                                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                                                                                                                                                                         // ============================================
                                                                                                                                                                                                                                                                                                                                                                                         // INITIALIZE APP ON PAGE LOAD
                                                                                                                                                                                                                                                                                                                                                                                         // ============================================

                                                                                                                                                                                                                                                                                                                                                                                         window.onload = function() {
                                                                                                                                                                                                                                                                                                                                                                                           console.log('üì± Page loaded, starting app...');
                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                               // Wait for Google library to load
                                                                                                                                                                                                                                                                                                                                                                                                 if (typeof google !== 'undefined') {
                                                                                                                                                                                                                                                                                                                                                                                                     initGoogleSignIn();
                                                                                                                                                                                                                                                                                                                                                                                                       } else {
                                                                                                                                                                                                                                                                                                                                                                                                           // Google library not loaded yet, wait 1 second
                                                                                                                                                                                                                                                                                                                                                                                                               console.log('‚è≥ Waiting for Google library...');
                                                                                                                                                                                                                                                                                                                                                                                                                   setTimeout(initGoogleSignIn, 1000);
                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                     };

// Will add code here shortly!